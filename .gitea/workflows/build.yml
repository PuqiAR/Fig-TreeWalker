name: Release Build
on:
  push:
    tags: ["*"]
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)"
        required: true
        default: "dev-build"

jobs:
  build-linux-x64:
    runs-on: ubuntu
    container:
      image: git.fig-lang.cn/puqiar/fig-ci:base-latest
      options: --network=host

    steps:
      - name: éªŒè¯æ„å»ºç¯å¢ƒ
        run: |
          echo "=== ç¯å¢ƒéªŒè¯å¼€å§‹ ==="
          xmake --version
          clang++ --version | head -1
          echo "=== ç¯å¢ƒéªŒè¯é€šè¿‡ ==="

      - name: æ£€å‡ºä»£ç 
        run: |
          git clone https://git.fig-lang.cn/${{ github.repository }} .
          git checkout ${{ github.ref }}

      - name: è®¾ç½®ç‰ˆæœ¬å’Œæäº¤ä¿¡æ¯
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # æ‹¿æäº¤æ¶ˆæ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "COMMIT_MSG<<EOF" >> $GITHUB_ENV
          echo "$COMMIT_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: æ„å»ºé¡¹ç›® (Linux)
        run: |
          echo "å¼€å§‹æ„å»ºLinuxç‰ˆæœ¬..."
          xmake f -p linux -a x86_64 -m release -y
          xmake build -j$(nproc) Fig
          echo "Linuxæ„å»ºæˆåŠŸã€‚"

      # ğŸ”§ æ–°å¢ï¼šæ„å»ºLinuxå¹³å°å®‰è£…å™¨
      - name: æ„å»ºLinuxå®‰è£…å™¨
        run: |
          echo "å¼€å§‹æ„å»ºLinuxå®‰è£…å™¨..."

          cd Installer/ConsoleInstaller

          python3 -m venv venv
          . venv/bin/activate

          pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

          # å®‰è£…ä¾èµ–å¹¶æ„å»º
          pip install --upgrade pip
          pip install -r requirements.txt
          python3 -m PyInstaller -F -n FigSetup-Linux --distpath ./dist/linux main.py
          echo "Linuxå®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Linuxå‘å¸ƒæ–‡ä»¶
        run: |
          VERSION="${{ env.VERSION }}"
          PACKAGE_NAME="Fig-${VERSION}-linux-x86_64"
          mkdir -p "${PACKAGE_NAME}"
          cp build/linux/x86_64/release/Fig "${PACKAGE_NAME}/"
          if [ -d "src/Module/Library" ]; then
            cp -r src/Module/Library "${PACKAGE_NAME}/"
            echo "å·²åŒ…å«Libraryç›®å½•ã€‚"
          fi
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
          sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.sha256"
          echo "Linuxæ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}.tar.gz"

      - name: å‘å¸ƒLinuxç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          VERSION="${{ env.VERSION }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.ref_name }}"
          fi
          COMMIT_MSG="${{ env.COMMIT_MSG }}"
          API="https://git.fig-lang.cn/api/v1/repos/${{ github.repository }}"
          
          echo "æ­£åœ¨æ£€æŸ¥ç‰ˆæœ¬ $VERSION çš„å‘å¸ƒçŠ¶æ€..."
          
          # å‡†å¤‡ JSON æ•°æ®
          VERSION="$VERSION" COMMIT_MSG="$COMMIT_MSG" python3 -c "import json, os; print(json.dumps({'tag_name': os.environ.get('VERSION', ''), 'name': 'Fig ' + os.environ.get('VERSION', ''), 'body': os.environ.get('COMMIT_MSG', ''), 'draft': False, 'prerelease': False}))" > release_body.json
          
          # 1. å°è¯•è·å–å·²æœ‰å‘å¸ƒ
          RESPONSE_TAG=$(curl -sS -H "Authorization: token $GITEA_TOKEN" "$API/releases/tags/$VERSION" 2>/dev/null || echo '{"id":0}')
          RELEASE_ID=$(echo "$RESPONSE_TAG" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          
          if [ -n "$RELEASE_ID" ] && [ "$RELEASE_ID" != "0" ]; then
            echo "âœ… æ‰¾åˆ°å·²æœ‰å‘å¸ƒ (ID: $RELEASE_ID)ï¼Œæ­£åœ¨æ›´æ–°è¯´æ˜..."
            curl -sS -X PATCH -H "Authorization: token $GITEA_TOKEN" \
              -H "Content-Type: application/json" \
              -d @release_body.json \
              "$API/releases/$RELEASE_ID" > /dev/null
          else
            echo "æœªæ‰¾åˆ°å·²æœ‰å‘å¸ƒï¼Œå‡†å¤‡åˆ›å»ºæ–°å‘å¸ƒ..."
            RESPONSE=$(curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
              -H "Content-Type: application/json" \
              -d @release_body.json \
              "$API/releases" 2>/dev/null || echo '{"id":0}')
            
            RELEASE_ID=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            
            if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "0" ]; then
               # å†æ¬¡å°è¯•è·å–ï¼Œé˜²æ­¢å¹¶å‘å†²çª
               RESPONSE_TAG=$(curl -sS -H "Authorization: token $GITEA_TOKEN" "$API/releases/tags/$VERSION" 2>/dev/null || echo '{"id":0}')
               RELEASE_ID=$(echo "$RESPONSE_TAG" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
            fi
          fi
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "0" ]; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•è·å–æˆ–åˆ›å»ºå‘å¸ƒ ID"
            exit 1
          fi
          
          echo "âœ… ä½¿ç”¨å‘å¸ƒ ID: $RELEASE_ID è¿›è¡Œä¸Šä¼ "
          
          # ä¸Šä¼ èµ„äº§
          PACKAGE_ZIP="Fig-$VERSION-linux-x86_64.tar.gz"
          PACKAGE_SHA="Fig-$VERSION-linux-x86_64.sha256"
          
          echo "æ­£åœ¨ä¸Šä¼  $PACKAGE_ZIP ..."
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$PACKAGE_ZIP" \
            "$API/releases/$RELEASE_ID/assets?name=$PACKAGE_ZIP" > /dev/null
          
          echo "æ­£åœ¨ä¸Šä¼  $PACKAGE_SHA ..."
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: text/plain" \
            --data-binary "@$PACKAGE_SHA" \
            "$API/releases/$RELEASE_ID/assets?name=$PACKAGE_SHA" > /dev/null
          
          # ğŸ”§ ä¸Šä¼ Linuxå®‰è£…å™¨
          INSTALLER="Installer/ConsoleInstaller/dist/linux/FigSetup-Linux"
          if [ -f "$INSTALLER" ]; then
            echo "æ­£åœ¨ä¸Šä¼ Linuxå®‰è£…å™¨..."
            curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary "@$INSTALLER" \
              "$API/releases/$RELEASE_ID/assets?name=FigSetup-Linux" > /dev/null
          fi
          
          echo "âœ… Linuxç‰ˆæœ¬å‘å¸ƒå®Œæˆï¼"

  build-windows-x64:
    runs-on: windows

    steps:
      - name: éªŒè¯Windowså·¥å…·é“¾
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          # æ£€æŸ¥ xmake
          if (Get-Command xmake -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… xmake å·²å®‰è£…'
            xmake --version
          } else { Write-Host 'è­¦å‘Š: xmake æœªæ‰¾åˆ°' }
          # æ£€æŸ¥ clang++
          if (Get-Command clang++ -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… clang++ å·²å®‰è£…'
            clang++ --version
          } else { Write-Host 'è­¦å‘Š: clang++ æœªæ‰¾åˆ°' }

      - name: æ£€å‡ºä»£ç 
        run: |
          $env:Path = "C:\Program Files\Git\cmd;$env:Path"
          git clone https://git.fig-lang.cn/$env:GITHUB_REPOSITORY .
          git checkout ${{ github.ref }}

      - name: è®¾ç½®ç‰ˆæœ¬å’Œæäº¤ä¿¡æ¯
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $VERSION = $env:INPUT_VERSION
            if (-not $VERSION) { $VERSION = $env:VERSION_INPUT }
            if (-not $VERSION) { $VERSION = "dev-build" }
          } else {
            $VERSION = "${{ github.ref_name }}"
          }
          Write-Host "æ„å»ºç‰ˆæœ¬: $VERSION"
          
          # ç¡®ä¿æ—  BOM çš„ UTF8
          [System.IO.File]::AppendAllText($env:GITHUB_ENV, "VERSION=$VERSION`n")
          
          # æäº¤æ¶ˆæ¯
          $COMMIT_MSG = git log -1 --pretty=%B
          [System.IO.File]::AppendAllText($env:GITHUB_ENV, "COMMIT_MSG<<EOF`n$COMMIT_MSG`nEOF`n")

      - name: æ„å»ºé¡¹ç›® (Windows Native)
        run: |
          xmake f -p windows -a x86_64 -m release -y
          xmake build -j $env:NUMBER_OF_PROCESSORS Fig
          Write-Host 'Windowsæ„å»ºæˆåŠŸã€‚'

      # ğŸ”§ æ–°å¢ï¼šæ„å»ºWindowså¹³å°å®‰è£…å™¨
      - name: æ„å»ºWindowså®‰è£…å™¨
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "å¼€å§‹æ„å»ºWindowså®‰è£…å™¨..."
          cd Installer\ConsoleInstaller
          pip install -r requirements.txt
          pyinstaller -F -i logo.ico -n FigSetup --distpath .\dist\windows main.py
          Write-Host "Windowså®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Windowså‘å¸ƒæ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          $VERSION = $env:VERSION
          if (-not $VERSION) {
            $VERSION = "${{ github.ref_name }}"
            Write-Host "âš ï¸  è­¦å‘Šï¼šä»ç¯å¢ƒå˜é‡è·å– VERSION å¤±è´¥ï¼Œå›é€€åˆ° github.ref_name: $VERSION"
          }
          Write-Host "æ‰“åŒ…ç‰ˆæœ¬: $VERSION"
          
          $PACKAGE_NAME = "Fig-${VERSION}-windows-x86_64"
          Write-Host "æ‰“åŒ…åç§°: $PACKAGE_NAME"
          
          New-Item -ItemType Directory -Force -Path $PACKAGE_NAME
          
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶
          if (Test-Path 'build\windows\x86_64\release\Fig.exe') {
            Copy-Item 'build\windows\x86_64\release\Fig.exe' $PACKAGE_NAME\
          } elseif (Test-Path 'build\windows\x86_64\release\Fig') {
            Copy-Item 'build\windows\x86_64\release\Fig' $PACKAGE_NAME\Fig.exe
          } else {
            Write-Host 'é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè¾“å‡ºæ–‡ä»¶'
            exit 1
          }
          
          if (Test-Path 'src\Module\Library') {
            Copy-Item -Recurse 'src\Module\Library' $PACKAGE_NAME\
          }
          
          # å‹ç¼©æ–‡ä»¶
          $ZIP_NAME = "$PACKAGE_NAME.zip"
          Compress-Archive -Path $PACKAGE_NAME -DestinationPath $ZIP_NAME
          
          # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
          $Hash = Get-FileHash $ZIP_NAME -Algorithm SHA256
          "$($Hash.Hash)  $ZIP_NAME" | Out-File "$PACKAGE_NAME.sha256" -Encoding UTF8
          
          Write-Host "Windowsæ‰“åŒ…å®Œæˆ: $ZIP_NAME"
          
      - name: å‘å¸ƒWindowsç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          $VERSION = $env:VERSION
          $COMMIT_MSG = $env:COMMIT_MSG
          
          if (-not $VERSION) {
            $VERSION = "${{ github.ref_name }}"
            Write-Host "âš ï¸  è­¦å‘Šï¼šä»ç¯å¢ƒå˜é‡è·å– VERSION å¤±è´¥ï¼Œå›é€€åˆ° github.ref_name: $VERSION"
          }
          
          if (-not $VERSION) {
            Write-Host "âŒ é”™è¯¯ï¼šç‰ˆæœ¬å·ä»ç„¶ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºå‘å¸ƒã€‚"
            exit 1
          }
          
          $REPO = $env:GITHUB_REPOSITORY
          $API = "https://git.fig-lang.cn/api/v1/repos/$REPO"
          $TOKEN = $env:GITEA_TOKEN
          $HEADERS = @{
            Authorization = "token $TOKEN"
            'Content-Type' = 'application/json'
          }
          
          $ZIP_FILE = "Fig-$VERSION-windows-x86_64.zip"
          $HASH_FILE = "Fig-$VERSION-windows-x86_64.sha256"
          $INSTALLER_PATH = "Installer\ConsoleInstaller\dist\windows\FigSetup.exe"
          
          if (-not (Test-Path $ZIP_FILE)) {
            Write-Host "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ZIPæ–‡ä»¶ $ZIP_FILE"
            exit 1
          }
          
          $CREATE_BODY = @{
            tag_name = $VERSION
            name = "Fig $VERSION"
            body = $COMMIT_MSG
            draft = $false
            prerelease = $false
          } | ConvertTo-Json -Compress
          
          Write-Host "æ­£åœ¨æ£€æŸ¥ç‰ˆæœ¬ $VERSION çš„å‘å¸ƒçŠ¶æ€..."
          $RELEASE_ID = $null
          
          try {
            $EXISTING = Invoke-RestMethod -Uri "$API/releases/tags/$VERSION" -Headers $HEADERS -ErrorAction Stop
            if ($EXISTING -and $EXISTING.id) {
              $RELEASE_ID = $EXISTING.id
              Write-Host "âœ… æ‰¾åˆ°å·²æœ‰å‘å¸ƒ (ID: $RELEASE_ID)ï¼Œæ­£åœ¨æ›´æ–°..."
              Invoke-RestMethod -Method Patch -Uri "$API/releases/$RELEASE_ID" -Headers $HEADERS -Body $CREATE_BODY -ErrorAction Stop | Out-Null
            }
          } catch {
            Write-Host "æœªæ‰¾åˆ°å·²æœ‰å‘å¸ƒï¼Œå‡†å¤‡åˆ›å»ºæ–°å‘å¸ƒ..."
          }
          
          if (-not $RELEASE_ID) {
            try {
              Write-Host "æ­£åœ¨åˆ›å»ºæ–°å‘å¸ƒ: $VERSION ..."
              $RESPONSE = Invoke-RestMethod -Method Post -Uri "$API/releases" -Headers $HEADERS -Body $CREATE_BODY -ErrorAction Stop
              $RELEASE_ID = $RESPONSE.id
              Write-Host "âœ… å‘å¸ƒåˆ›å»ºæˆåŠŸ (ID: $RELEASE_ID)"
            } catch {
              $err = $_.Exception.Message
              Write-Host "âŒ åˆ›å»ºå‘å¸ƒå¤±è´¥: $err"
              # æœ€åä¸€æ¬¡å°è¯•ï¼šå†æ¬¡å°è¯•æŒ‰æ ‡ç­¾è·å–ï¼Œé˜²æ­¢ç”±äºå¹¶å‘å¯¼è‡´çš„å†²çª
              try {
                $RETRY = Invoke-RestMethod -Uri "$API/releases/tags/$VERSION" -Headers $HEADERS -ErrorAction Stop
                $RELEASE_ID = $RETRY.id
                Write-Host "âœ… é‡è¯•è·å–å‘å¸ƒæˆåŠŸ (ID: $RELEASE_ID)"
              } catch {
                Write-Host "âŒ æ— æ³•è·å–æˆ–åˆ›å»ºå‘å¸ƒ ID"
                exit 1
              }
            }
          }
          
          # ä¸Šä¼ èµ„äº§
          Write-Host "æ­£åœ¨ä¸Šä¼ æ–‡ä»¶..."
          $ASSETS = @(
            @{ Name = $ZIP_FILE; Path = $ZIP_FILE; ContentType = "application/octet-stream" },
            @{ Name = $HASH_FILE; Path = $HASH_FILE; ContentType = "text/plain" }
          )
          
          if (Test-Path $INSTALLER_PATH) {
            $ASSETS += @{ Name = "FigSetup.exe"; Path = $INSTALLER_PATH; ContentType = "application/octet-stream" }
          }
          
          foreach ($asset in $ASSETS) {
            Write-Host "æ­£åœ¨ä¸Šä¼  $($asset.Name) ..."
            try {
              # å¦‚æœèµ„äº§å·²å­˜åœ¨ï¼ŒGitea å¯èƒ½ä¼šæŠ¥é”™ï¼Œè¿™é‡Œç®€å•å¤„ç†
              Invoke-RestMethod -Method Post -Uri "$API/releases/$RELEASE_ID/assets?name=$($asset.Name)" `
                -Headers @{ Authorization = "token $TOKEN"; 'Content-Type' = $asset.ContentType } `
                -InFile $asset.Path -ErrorAction SilentlyContinue | Out-Null
            } catch {
              Write-Host "âš ï¸ ä¸Šä¼  $($asset.Name) å¤±è´¥ï¼Œå¯èƒ½å·²å­˜åœ¨ã€‚"
            }
          }
          
          Write-Host "âœ… Windowsç‰ˆæœ¬å‘å¸ƒå®Œæˆï¼"