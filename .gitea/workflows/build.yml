name: Release Build
on:
  push:
    tags: ["*"]
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)"
        required: true
        default: "dev-build"

jobs:
  build-linux-x64:
    runs-on: ubuntu
    container:
      image: git.fig-lang.cn/puqiar/fig-ci:base-latest
      options: --network=host

    steps:
      - name: éªŒè¯æ„å»ºç¯å¢ƒ
        run: |
          echo "=== ç¯å¢ƒéªŒè¯å¼€å§‹ ==="
          xmake --version
          clang++ --version | head -1
          echo "=== ç¯å¢ƒéªŒè¯é€šè¿‡ ==="

      - name: æ£€å‡ºä»£ç 
        run: |
          git clone https://git.fig-lang.cn/${{ github.repository }} .
          git checkout ${{ github.ref }}

      - name: è®¾ç½®ç‰ˆæœ¬
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: æ„å»ºé¡¹ç›® (Linux)
        run: |
          echo "å¼€å§‹æ„å»ºLinuxç‰ˆæœ¬..."
          xmake f -p linux -a x86_64 -m release -y
          xmake build -j$(nproc)
          echo "Linuxæ„å»ºæˆåŠŸã€‚"

      # ğŸ”§ æ–°å¢ï¼šæ„å»ºLinuxå¹³å°å®‰è£…å™¨
      - name: æ„å»ºLinuxå®‰è£…å™¨
        run: |
          echo "å¼€å§‹æ„å»ºLinuxå®‰è£…å™¨..."

          cd Installer/ConsoleInstaller

          python3 -m venv venv
          . venv/bin/activate

          pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple

          # å®‰è£…ä¾èµ–å¹¶æ„å»º
          pip install --upgrade pip
          pip install -r requirements.txt
          python3 -m PyInstaller -F -n FigSetup-Linux --distpath ./dist/linux main.py
          echo "Linuxå®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Linuxå‘å¸ƒæ–‡ä»¶
        run: |
          VERSION="${{ env.VERSION }}"
          PACKAGE_NAME="Fig-${VERSION}-linux-x86_64"
          mkdir -p "${PACKAGE_NAME}"
          cp build/linux/x86_64/release/Fig "${PACKAGE_NAME}/"
          if [ -d "src/Module/Library" ]; then
            cp -r src/Module/Library "${PACKAGE_NAME}/"
            echo "å·²åŒ…å«Libraryç›®å½•ã€‚"
          fi
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
          sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.sha256"
          echo "Linuxæ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}.tar.gz"

      - name: å‘å¸ƒLinuxç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          VERSION="${{ env.VERSION }}"
          API="https://git.fig-lang.cn/api/v1/repos/${{ github.repository }}"
          
          echo "æ­£åœ¨ä¸ºLinuxç‰ˆæœ¬åˆ›å»º/æ›´æ–°å‘å¸ƒ $VERSION ..."
          
          RESPONSE=$(curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$VERSION\",\"name\":\"Fig $VERSION\",\"draft\":false,\"prerelease\":false}" \
            "$API/releases" 2>/dev/null || echo '{"id":0}')
          
          RELEASE_ID=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "0" ]; then
            echo "å°è¯•é€šè¿‡æ ‡ç­¾è·å–å·²æœ‰å‘å¸ƒçš„ID..."
            RELEASE_ID=$(curl -sS -H "Authorization: token $GITEA_TOKEN" \
              "$API/releases/tags/$VERSION" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–æˆ–åˆ›å»ºå‘å¸ƒ ID"
            exit 1
          fi
          
          echo "ä½¿ç”¨å‘å¸ƒ ID: $RELEASE_ID è¿›è¡Œä¸Šä¼ "
          
          # ä¸Šä¼ è¯­è¨€åŒ…
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @Fig-$VERSION-linux-x86_64.tar.gz \
            "$API/releases/$RELEASE_ID/assets?name=Fig-$VERSION-linux-x86_64.tar.gz"
          
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: text/plain" \
            --data-binary @Fig-$VERSION-linux-x86_64.sha256 \
            "$API/releases/$RELEASE_ID/assets?name=Fig-$VERSION-linux-x86_64.sha256"
          
          # ğŸ”§ æ–°å¢ï¼šä¸Šä¼ Linuxå®‰è£…å™¨
          if [ -f "Installer/ConsoleInstaller/dist/linux/FigSetup-Linux" ]; then
            echo "æ­£åœ¨ä¸Šä¼ Linuxå®‰è£…å™¨..."
            curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @Installer/ConsoleInstaller/dist/linux/FigSetup-Linux \
              "$API/releases/$RELEASE_ID/assets?name=FigSetup-Linux"
          fi
          
          echo "âœ… Linuxç‰ˆæœ¬å‘å¸ƒå®Œæˆï¼"

  build-windows-x64:
    runs-on: windows

    steps:
      - name: éªŒè¯Windowså·¥å…·é“¾
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          # æ£€æŸ¥ xmake
          if (Get-Command xmake -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… xmake å·²å®‰è£…'
            xmake --version
          } else { Write-Host 'è­¦å‘Š: xmake æœªæ‰¾åˆ°' }
          # æ£€æŸ¥ clang++
          if (Get-Command clang++ -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… clang++ å·²å®‰è£…'
            clang++ --version
          } else { Write-Host 'è­¦å‘Š: clang++ æœªæ‰¾åˆ°' }

      - name: æ£€å‡ºä»£ç 
        run: |
          $env:Path = "C:\Program Files\Git\cmd;$env:Path"
          git clone https://git.fig-lang.cn/$env:GITHUB_REPOSITORY .
          git checkout $env:GITHUB_REF

      - name: è®¾ç½®ç‰ˆæœ¬
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $VERSION = $env:INPUT_VERSION
            if (-not $VERSION) { $VERSION = $env:VERSION_INPUT }
            if (-not $VERSION) { $VERSION = "dev-build" }
          } else {
            $VERSION = $env:GITHUB_REF_NAME
          }
          Write-Host "æ„å»ºç‰ˆæœ¬: $VERSION"
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: æ„å»ºé¡¹ç›® (Windows Native)
        run: |
          xmake f -p windows -a x86_64 -m release -y
          xmake build -j $env:NUMBER_OF_PROCESSORS
          Write-Host 'Windowsæ„å»ºæˆåŠŸã€‚'

      # ğŸ”§ æ–°å¢ï¼šæ„å»ºWindowså¹³å°å®‰è£…å™¨
      - name: æ„å»ºWindowså®‰è£…å™¨
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "å¼€å§‹æ„å»ºWindowså®‰è£…å™¨..."
          cd Installer\ConsoleInstaller
          pip install -r requirements.txt
          pyinstaller -F -i logo.ico -n FigSetup --distpath .\dist\windows main.py
          Write-Host "Windowså®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Windowså‘å¸ƒæ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          # ğŸ”§ ä¿®æ”¹ï¼šä¸å‘å¸ƒæ­¥éª¤ä½¿ç”¨ç›¸åŒçš„ç‰ˆæœ¬å·è®¡ç®—é€»è¾‘
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $VERSION = $env:INPUT_VERSION
            if (-not $VERSION) { $VERSION = "dev-build" }
          } else {
            $VERSION = $env:GITHUB_REF_NAME
          }
          
          Write-Host "æ‰“åŒ…ç‰ˆæœ¬: $VERSION"
          
          $PACKAGE_NAME = "Fig-${VERSION}-windows-x86_64"
          Write-Host "æ‰“åŒ…åç§°: $PACKAGE_NAME"
          
          New-Item -ItemType Directory -Force -Path $PACKAGE_NAME
          
          # æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶
          if (Test-Path 'build\windows\x86_64\release\Fig.exe') {
            Copy-Item 'build\windows\x86_64\release\Fig.exe' $PACKAGE_NAME\
          } elseif (Test-Path 'build\windows\x86_64\release\Fig') {
            Copy-Item 'build\windows\x86_64\release\Fig' $PACKAGE_NAME\Fig.exe
          } else {
            Write-Host 'é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè¾“å‡ºæ–‡ä»¶'
            exit 1
          }
          
          if (Test-Path 'src\Module\Library') {
            Copy-Item -Recurse 'src\Module\Library' $PACKAGE_NAME\
          }
          
          # å‹ç¼©æ–‡ä»¶
          $ZIP_NAME = "$PACKAGE_NAME.zip"
          Compress-Archive -Path $PACKAGE_NAME -DestinationPath $ZIP_NAME
          
          # ç”Ÿæˆæ ¡éªŒæ–‡ä»¶
          $Hash = Get-FileHash $ZIP_NAME -Algorithm SHA256
          "$($Hash.Hash)  $ZIP_NAME" | Out-File "$PACKAGE_NAME.sha256" -Encoding UTF8
          
          Write-Host "Windowsæ‰“åŒ…å®Œæˆ: $ZIP_NAME"
          
      - name: å‘å¸ƒWindowsç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          # é‡æ–°è®¡ç®—ç‰ˆæœ¬å·ï¼ˆä¸ä½¿ç”¨ $env:VERSIONï¼‰
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            $VERSION = $env:INPUT_VERSION
            if (-not $VERSION) { $VERSION = "dev-build" }
          } else {
            $VERSION = $env:GITHUB_REF_NAME
          }
          
          Write-Host "æ­£åœ¨ä¸Šä¼ Windowsç‰ˆæœ¬åˆ°å‘å¸ƒ: $VERSION"
          
          $REPO = $env:GITHUB_REPOSITORY
          $API = "https://git.fig-lang.cn/api/v1/repos/$REPO"
          $TOKEN = $env:GITEA_TOKEN
          
          # ğŸ”§ æ–°å¢ï¼šæ£€æŸ¥å¿…éœ€çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          $ZIP_FILE = "Fig-$VERSION-windows-x86_64.zip"
          $HASH_FILE = "Fig-$VERSION-windows-x86_64.sha256"
          $INSTALLER_PATH = "Installer\ConsoleInstaller\dist\windows\FigSetup.exe"
          
          if (-not (Test-Path $ZIP_FILE)) {
            Write-Host "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ZIPæ–‡ä»¶ $ZIP_FILE"
            Get-ChildItem *.zip
            exit 1
          }
          
          Write-Host "æ­£åœ¨ä¸ºWindowsç‰ˆæœ¬åˆ›å»º/æ›´æ–°å‘å¸ƒ $VERSION ..."
          
          # ğŸ”§ å…³é”®ä¿®æ”¹ï¼šç›´æ¥åˆ›å»ºå‘å¸ƒï¼Œä¸å…ˆæ£€æŸ¥ï¼ˆä¸Linuxé€»è¾‘ä¸€è‡´ï¼‰
          $CREATE_BODY = @{
            tag_name = $VERSION
            name = "Fig $VERSION"
            draft = $false
            prerelease = $false
          } | ConvertTo-Json -Compress
          
          Write-Host "åˆ›å»ºå‘å¸ƒè¯·æ±‚ä½“: $CREATE_BODY"
          
          # ç›´æ¥åˆ›å»ºå‘å¸ƒï¼ˆGiteaä¼šè‡ªåŠ¨å¤„ç†é‡å¤åˆ›å»ºï¼‰
          $RESPONSE = Invoke-RestMethod -Method Post -Uri "$API/releases" `
            -Headers @{
              Authorization = "token $TOKEN"
              'Content-Type' = 'application/json'
            } -Body $CREATE_BODY -ErrorAction SilentlyContinue
          
          if (-not $RESPONSE -or -not $RESPONSE.id) {
            # å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œå°è¯•é€šè¿‡æ ‡ç­¾è·å–å·²æœ‰å‘å¸ƒçš„ID
            Write-Host "åˆ›å»ºå¤±è´¥ï¼Œå°è¯•è·å–å·²æœ‰å‘å¸ƒ..."
            $RESPONSE = Invoke-RestMethod -Uri "$API/releases/tags/$VERSION" `
              -Headers @{Authorization = "token $TOKEN" } `
              -ErrorAction SilentlyContinue
          }
          
          if ($RESPONSE -and $RESPONSE.id) {
            $RELEASE_ID = $RESPONSE.id
            Write-Host "âœ… ä½¿ç”¨å‘å¸ƒ ID: $RELEASE_ID è¿›è¡Œä¸Šä¼ "
          } else {
            Write-Host "âŒ é”™è¯¯ï¼šæ— æ³•è·å–æˆ–åˆ›å»ºå‘å¸ƒ ID"
            exit 1
          }
          
          # ä¸Šä¼ èµ„äº§
          Write-Host "æ­£åœ¨ä¸Šä¼  ZIP æ–‡ä»¶..."
          Invoke-RestMethod -Method Post -Uri "$API/releases/$RELEASE_ID/assets?name=$ZIP_FILE" `
            -Headers @{
              Authorization = "token $TOKEN"
              'Content-Type' = 'application/octet-stream'
            } -InFile $ZIP_FILE -ErrorAction SilentlyContinue
          
          Write-Host "æ­£åœ¨ä¸Šä¼ æ ¡éªŒæ–‡ä»¶..."
          Invoke-RestMethod -Method Post -Uri "$API/releases/$RELEASE_ID/assets?name=$HASH_FILE" `
            -Headers @{
              Authorization = "token $TOKEN"
              'Content-Type' = 'text/plain'
            } -InFile $HASH_FILE -ErrorAction SilentlyContinue
          
          # ä¸Šä¼ Windowså®‰è£…å™¨
          if (Test-Path $INSTALLER_PATH) {
            Write-Host "æ­£åœ¨ä¸Šä¼ Windowså®‰è£…å™¨..."
            Invoke-RestMethod -Method Post -Uri "$API/releases/$RELEASE_ID/assets?name=FigSetup.exe" `
              -Headers @{
                Authorization = "token $TOKEN"
                'Content-Type' = 'application/octet-stream'
              } -InFile $INSTALLER_PATH -ErrorAction SilentlyContinue
          } else {
            Write-Host "âš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ°å®‰è£…å™¨æ–‡ä»¶ $INSTALLER_PATH"
          }
          
          Write-Host "âœ… Windowsç‰ˆæœ¬å‘å¸ƒå®Œæˆï¼"