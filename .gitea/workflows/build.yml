name: Release Build
on:
  push:
    tags: ["*"]
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0, v1.1.0-alpha)"
        required: true
        default: "dev-build"

jobs:
  build-linux-x64:
    runs-on: ubuntu
    container:
      image: git.fig-lang.cn/puqiar/fig-ci:base-latest
      options: --network=host

    steps:
      - name: éªŒè¯æ„å»ºç¯å¢ƒ
        run: |
          echo "=== ç¯å¢ƒéªŒè¯å¼€å§‹ ==="
          xmake --version
          clang++ --version | head -1
          echo "=== ç¯å¢ƒéªŒè¯é€šè¿‡ ==="

      - name: æ£€å‡ºä»£ç 
        run: |
          git clone https://git.fig-lang.cn/${{ github.repository }} .
          git checkout ${{ github.ref }}

      - name: è®¾ç½®ç‰ˆæœ¬
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "æ„å»ºç‰ˆæœ¬: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: è·å–æäº¤ä¿¡æ¯
        run: |
          # è·å–æœ€æ–°æäº¤ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ ‡ç­¾åˆ™è·å–æ ‡ç­¾æŒ‡å‘çš„æäº¤
          if git describe --tags --exact-match >/dev/null 2>&1; then
            # æ ‡ç­¾å‘å¸ƒï¼šè·å–æ ‡ç­¾å…³è”çš„æäº¤ä¿¡æ¯
            COMMIT_HASH=$(git rev-list -n 1 $VERSION)
            COMMIT_MSG=$(git log -1 --pretty=format:"%s" $COMMIT_HASH)
            COMMIT_BODY=$(git log -1 --pretty=format:"%b" $COMMIT_HASH)
          else
            # æ‰‹åŠ¨è§¦å‘æˆ–éæ ‡ç­¾æäº¤ï¼šè·å–æœ€æ–°æäº¤ä¿¡æ¯
            COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            COMMIT_BODY=$(git log -1 --pretty=format:"%b")
          fi
          
          # ç»„åˆå®Œæ•´çš„æäº¤ä¿¡æ¯
          if [ -n "$COMMIT_BODY" ]; then
            RELEASE_BODY="${COMMIT_MSG}%0A%0A${COMMIT_BODY}"
          else
            RELEASE_BODY="${COMMIT_MSG}"
          fi
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "RELEASE_BODY=${RELEASE_BODY}" >> $GITHUB_ENV
          echo "æäº¤ä¿¡æ¯å·²ä¿å­˜"

      - name: æ„å»ºé¡¹ç›® (Linux)
        run: |
          echo "å¼€å§‹æ„å»ºLinuxç‰ˆæœ¬..."
          xmake f -p linux -a x86_64 -m release -y
          xmake build -j$(nproc)
          echo "Linuxæ„å»ºæˆåŠŸã€‚"

      - name: æ„å»ºLinuxå®‰è£…å™¨
        run: |
          echo "å¼€å§‹æ„å»ºLinuxå®‰è£…å™¨..."
          cd Installer/ConsoleInstaller
          python3 -m venv venv
          . venv/bin/activate
          pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple
          pip install --upgrade pip
          pip install -r requirements.txt
          python3 -m PyInstaller -F -n FigSetup-Linux --distpath ./dist/linux main.py
          echo "Linuxå®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Linuxå‘å¸ƒæ–‡ä»¶
        run: |
          VERSION="${{ env.VERSION }}"
          PACKAGE_NAME="Fig-${VERSION}-linux-x86_64"
          mkdir -p "${PACKAGE_NAME}"
          cp build/linux/x86_64/release/Fig "${PACKAGE_NAME}/"
          if [ -d "src/Module/Library" ]; then
            cp -r src/Module/Library "${PACKAGE_NAME}/"
            echo "å·²åŒ…å«Libraryç›®å½•ã€‚"
          fi
          tar -czf "${PACKAGE_NAME}.tar.gz" "${PACKAGE_NAME}"
          sha256sum "${PACKAGE_NAME}.tar.gz" > "${PACKAGE_NAME}.sha256"
          echo "Linuxæ‰“åŒ…å®Œæˆ: ${PACKAGE_NAME}.tar.gz"

      - name: å‘å¸ƒLinuxç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          VERSION="${{ env.VERSION }}"
          RELEASE_BODY="${{ env.RELEASE_BODY }}"
          API="https://git.fig-lang.cn/api/v1/repos/${{ github.repository }}"
          
          # ä¿®å¤ï¼šä½¿ç”¨å…¼å®¹æ€§æœ€å¥½çš„caseè¯­å¥åˆ¤æ–­é¢„å‘å¸ƒç‰ˆæœ¬
          case "$VERSION" in
            *-alpha* | *-beta* | *-dev* | *-rc* | dev-build)
              PRERELEASE=true
              echo "æ£€æµ‹åˆ°é¢„å‘å¸ƒç‰ˆæœ¬: $VERSION"
              ;;
            *)
              PRERELEASE=false
              echo "æ£€æµ‹åˆ°ç¨³å®šç‰ˆæœ¬: $VERSION"
              ;;
          esac
          
          echo "æ­£åœ¨ä¸ºLinuxç‰ˆæœ¬åˆ›å»º/æ›´æ–°å‘å¸ƒ $VERSION ..."
          
          RESPONSE=$(curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\":\"$VERSION\",\"name\":\"Fig $VERSION\",\"body\":\"$RELEASE_BODY\",\"draft\":false,\"prerelease\":$PRERELEASE}" \
            "$API/releases" 2>/dev/null || echo '{"id":0}')
          
          RELEASE_ID=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "0" ]; then
            echo "å°è¯•é€šè¿‡æ ‡ç­¾è·å–å·²æœ‰å‘å¸ƒçš„ID..."
            RELEASE_ID=$(curl -sS -H "Authorization: token $GITEA_TOKEN" \
              "$API/releases/tags/$VERSION" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          fi
          
          if [ -z "$RELEASE_ID" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•è·å–æˆ–åˆ›å»ºå‘å¸ƒ ID"
            exit 1
          fi
          
          echo "ä½¿ç”¨å‘å¸ƒ ID: $RELEASE_ID è¿›è¡Œä¸Šä¼ "
          
          # ä¸Šä¼ è¯­è¨€åŒ…
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @Fig-$VERSION-linux-x86_64.tar.gz \
            "$API/releases/$RELEASE_ID/assets?name=Fig-$VERSION-linux-x86_64.tar.gz"
          
          curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
            -H "Content-Type: text/plain" \
            --data-binary @Fig-$VERSION-linux-x86_64.sha256 \
            "$API/releases/$RELEASE_ID/assets?name=Fig-$VERSION-linux-x86_64.sha256"
          
          # ä¸Šä¼ Linuxå®‰è£…å™¨
          if [ -f "Installer/ConsoleInstaller/dist/linux/FigSetup-Linux" ]; then
            echo "æ­£åœ¨ä¸Šä¼ Linuxå®‰è£…å™¨..."
            curl -sS -X POST -H "Authorization: token $GITEA_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @Installer/ConsoleInstaller/dist/linux/FigSetup-Linux \
              "$API/releases/$RELEASE_ID/assets?name=FigSetup-Linux"
          fi
          
          echo "âœ… Linuxç‰ˆæœ¬å‘å¸ƒå®Œæˆï¼"

  build-windows-x64:
    runs-on: windows

    steps:
      - name: éªŒè¯Windowså·¥å…·é“¾
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          if (Get-Command xmake -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… xmake å·²å®‰è£…'
            xmake --version
          } else { Write-Host 'è­¦å‘Š: xmake æœªæ‰¾åˆ°' }
          if (Get-Command clang++ -ErrorAction SilentlyContinue) {
            Write-Host 'âœ… clang++ å·²å®‰è£…'
            clang++ --version
          } else { Write-Host 'è­¦å‘Š: clang++ æœªæ‰¾åˆ°' }

      - name: æ£€å‡ºä»£ç 
        run: |
          $env:Path = "C:\Program Files\Git\cmd;$env:Path"
          git clone https://git.fig-lang.cn/$env:GITHUB_REPOSITORY .
          git checkout $env:GITHUB_REF

      - name: è®¾ç½®ç‰ˆæœ¬å’Œæäº¤ä¿¡æ¯ (Windows)
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          # æœ€ç®€ç‰ˆæœ¬é€»è¾‘
          # æ‰‹åŠ¨è§¦å‘ -> ä½¿ç”¨è¾“å…¥æ¡†çš„æ–‡æœ¬ï¼ˆé»˜è®¤æ˜¯dev-buildï¼‰
          # æ ‡ç­¾æ¨é€ -> ä½¿ç”¨æ ‡ç­¾å
          
          if ($env:GITHUB_EVENT_NAME -eq 'workflow_dispatch') {
            # æ‰‹åŠ¨è§¦å‘ï¼šä½¿ç”¨è¾“å…¥æ¡†çš„å€¼
            $VERSION = '${{ inputs.version }}'
          } else {
            # æ ‡ç­¾æ¨é€ï¼šä½¿ç”¨æ ‡ç­¾å
            $VERSION = '${{ github.ref_name }}'
          }
          
          Write-Host "æ„å»ºç‰ˆæœ¬: $VERSION"
          
          # è·å–æäº¤ä¿¡æ¯
          $COMMIT_MSG = git log -1 --pretty=format:"%s" 2>$null
          $COMMIT_BODY = git log -1 --pretty=format:"%b" 2>$null
          
          $RELEASE_BODY = $COMMIT_MSG
          if (-not [string]::IsNullOrWhiteSpace($COMMIT_BODY)) {
            $RELEASE_BODY = "${COMMIT_MSG}`n`n${COMMIT_BODY}"
          }
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          $RELEASE_BODY_JSON = $RELEASE_BODY -replace "`r`n", "\n" -replace "`n", "\n"
          "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "RELEASE_BODY=$RELEASE_BODY_JSON" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          
          Write-Host "ç‰ˆæœ¬å’Œæäº¤ä¿¡æ¯å·²è®¾ç½®"

      - name: æ„å»ºé¡¹ç›® (Windows Native)
        run: |
          xmake f -p windows -a x86_64 -m release -y
          xmake build -j $env:NUMBER_OF_PROCESSORS
          Write-Host 'Windowsæ„å»ºæˆåŠŸã€‚'

      - name: æ„å»ºWindowså®‰è£…å™¨
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          Write-Host "å¼€å§‹æ„å»ºWindowså®‰è£…å™¨..."
          cd Installer\ConsoleInstaller
          pip install -r requirements.txt
          pyinstaller -F -i logo.ico -n FigSetup --distpath .\dist\windows main.py
          Write-Host "Windowså®‰è£…å™¨æ„å»ºå®Œæˆ"

      - name: æ‰“åŒ…Windowså‘å¸ƒæ–‡ä»¶
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          $VERSION = $env:VERSION
          Write-Host "æ‰“åŒ…ç‰ˆæœ¬: $VERSION"
          
          $PACKAGE_NAME = "Fig-${VERSION}-windows-x86_64"
          Write-Host "æ‰“åŒ…åç§°: $PACKAGE_NAME"
          
          New-Item -ItemType Directory -Force -Path $PACKAGE_NAME
          
          if (Test-Path 'build\windows\x86_64\release\Fig.exe') {
            Copy-Item 'build\windows\x86_64\release\Fig.exe' $PACKAGE_NAME\
          } elseif (Test-Path 'build\windows\x86_64\release\Fig') {
            Copy-Item 'build\windows\x86_64\release\Fig' $PACKAGE_NAME\Fig.exe
          } else {
            Write-Host 'é”™è¯¯ï¼šæœªæ‰¾åˆ°æ„å»ºè¾“å‡ºæ–‡ä»¶'
            exit 1
          }
          
          if (Test-Path 'src\Module\Library') {
            Copy-Item -Recurse 'src\Module\Library' $PACKAGE_NAME\
          }
          
          $ZIP_NAME = "$PACKAGE_NAME.zip"
          Compress-Archive -Path $PACKAGE_NAME -DestinationPath $ZIP_NAME
          
          $Hash = Get-FileHash $ZIP_NAME -Algorithm SHA256
          "$($Hash.Hash)  $ZIP_NAME" | Out-File "$PACKAGE_NAME.sha256" -Encoding UTF8
          
          Write-Host "Windowsæ‰“åŒ…å®Œæˆ: $ZIP_NAME"
          
      - name: å‘å¸ƒWindowsç‰ˆæœ¬åˆ°Gitea
        env:
          GITEA_TOKEN: ${{ secrets.CI_TOKEN }}
        run: |
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          
          # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šä¸ä¾èµ–ä»»ä½•å‰ç½®ç¯å¢ƒå˜é‡ï¼Œè‡ªè¡Œè·å–ç‰ˆæœ¬
          Write-Host â€œ=== å¼€å§‹å‘å¸ƒæµç¨‹ ==="
          
          # 1. ç¡®å®šç‰ˆæœ¬å· (å”¯ä¸€å¯é æ¥æºï¼šGitä»“åº“æœ¬èº«)
          $VERSION = $null
          
          # é¦–å…ˆå°è¯•è·å–å½“å‰HEADæŒ‡å‘çš„ç²¾ç¡®æ ‡ç­¾
          $exactTag = git describe --tags --exact-match 2>$null
          if ($exactTag) {
              $VERSION = $exactTag.Trim()
              Write-Host â€œæ–¹å¼ä¸€ï¼šé€šè¿‡ç²¾ç¡®æ ‡ç­¾è·å–ç‰ˆæœ¬: $VERSIONâ€
          }
          
          # å¦‚æœå¤±è´¥ï¼Œå°è¯•è·å–æŒ‡å‘å½“å‰HEADçš„æ‰€æœ‰æ ‡ç­¾
          if (-not $VERSION) {
              $tagsAtHead = git tag --points-at HEAD 2>$null
              if ($tagsAtHead) {
                  $VERSION = ($tagsAtHead -split â€œ`nâ€)[0].Trim()
                  Write-Host â€œæ–¹å¼äºŒï¼šé€šè¿‡HEADå…³è”æ ‡ç­¾è·å–ç‰ˆæœ¬: $VERSIONâ€
              }
          }
          
          # å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¯´æ˜æ˜¯æ‰‹åŠ¨è§¦å‘æˆ–æ— æ ‡ç­¾æ¨é€ï¼Œä½¿ç”¨ dev-build
          if (-not $VERSION) {
              $VERSION = â€œdev-buildâ€
              Write-Host â€œæ–¹å¼ä¸‰ï¼šæ— æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬: $VERSIONâ€
          }
          
          Write-Host â€œæœ€ç»ˆå‘å¸ƒç‰ˆæœ¬: $VERSIONâ€
          
          # 2. æ ¹æ®ç‰ˆæœ¬åç¼€åˆ¤æ–­æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          if ($VERSION -match â€˜-(alpha|beta|dev|rc)â€™) {
              $PRERELEASE = $true
              Write-Host â€œç‰ˆæœ¬ç±»å‹ï¼šé¢„å‘å¸ƒç‰ˆæœ¬â€
          } elseif ($VERSION -eq â€˜dev-buildâ€™) {
              $PRERELEASE = $true
              Write-Host â€œç‰ˆæœ¬ç±»å‹ï¼šå¼€å‘æ„å»ºâ€
          } else {
              $PRERELEASE = $false
              Write-Host â€œç‰ˆæœ¬ç±»å‹ï¼šç¨³å®šç‰ˆæœ¬â€
          }
          
          # 3. è·å–æœ¬æ¬¡æäº¤ä¿¡æ¯ä½œä¸ºå‘å¸ƒæè¿°
          $COMMIT_MSG = git log -1 --pretty=format:â€œ%sâ€ 2>$null
          $COMMIT_BODY = git log -1 --pretty=format:â€œ%bâ€ 2>$null
          
          $RELEASE_BODY = $COMMIT_MSG
          if (-not [string]::IsNullOrWhiteSpace($COMMIT_BODY)) {
              $RELEASE_BODY = â€œ${COMMIT_MSG}`n`n${COMMIT_BODY}â€
          }
          
          # å°†æ­£æ–‡ä¸­çš„æ¢è¡Œç¬¦è½¬æ¢ä¸ºJSONå¯è¯†åˆ«çš„\n
          $RELEASE_BODY_JSON = $RELEASE_BODY -replace â€œ`r`nâ€ï¼Œ â€œ\nâ€ -replace â€œ`nâ€ï¼Œ â€œ\nâ€
          
          Write-Host â€œå‘å¸ƒæè¿°: $RELEASE_BODYâ€
          
          # 4. è®¾ç½®APIç›¸å…³å˜é‡
          $REPO = $env:GITHUB_REPOSITORY
          $API = â€œhttps://git.fig-lang.cn/api/v1/repos/$REPOâ€
          $TOKEN = $env:GITEA_TOKEN
          
          # 5. æ£€æŸ¥å¿…éœ€çš„æ–‡ä»¶
          $ZIP_FILE = â€œFig-$VERSION-windows-x86_64.zipâ€
          $HASH_FILE = â€œFig-$VERSION-windows-x86_64.sha256â€
          $INSTALLER_PATH = â€œInstaller\ConsoleInstaller\dist\windows\FigSetup.exeâ€
          
          if (-not (Test-Path $ZIP_FILE)) {
              Write-Host â€œâŒ è‡´å‘½é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ„å»ºäº§ç‰© $ZIP_FILEâ€
              Write-Host â€œå½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨ï¼šâ€
              Get-ChildItem *.zip
              exit 1
          }
          
          Write-Host â€œæ­£åœ¨ä¸ºç‰ˆæœ¬ [$VERSION] åˆ›å»º/æ›´æ–°å‘å¸ƒ...â€
          
          # 6. åˆ›å»ºå‘å¸ƒè¯·æ±‚ä½“
          $CREATE_BODY = @{
              tag_name = $VERSION
              name = â€œFig $VERSIONâ€
              body = $RELEASE_BODY_JSON
              draft = $false
              prerelease = $PRERELEASE
          } | ConvertTo-Json
          
          Write-Host â€œå‘å¸ƒè¯·æ±‚ä½“: $CREATE_BODYâ€
          
          # 7. åˆ›å»ºæˆ–è·å–å·²æœ‰çš„å‘å¸ƒ
          $RESPONSE = Invoke-RestMethod -Method Post -Uri â€œ$API/releasesâ€ `
              -Headers @{
                  Authorization = â€œtoken $TOKENâ€
                  â€˜Content-Typeâ€™ = â€˜application/jsonâ€™
              } -Body $CREATE_BODY -ErrorAction SilentlyContinue
          
          if (-not $RESPONSE -or -not $RESPONSE.id) {
              Write-Host â€œåˆ›å»ºæ–°å‘å¸ƒå¤±è´¥ï¼Œå°è¯•è·å–å·²æœ‰å‘å¸ƒ...â€
              $RESPONSE = Invoke-RestMethod -Uri â€œ$API/releases/tags/$VERSIONâ€ `
                  -Headers @{Authorization = â€œtoken $TOKENâ€ } `
                  -ErrorAction SilentlyContinue
          }
          
          if ($RESPONSE -and $RESPONSE.id) {
              $RELEASE_ID = $RESPONSE.id
              Write-Host â€œâœ… æˆåŠŸè·å–å‘å¸ƒ ID: $RELEASE_IDâ€
          } else {
              Write-Host â€œâŒ è‡´å‘½é”™è¯¯ï¼šæ— æ³•åˆ›å»ºæˆ–è·å–å‘å¸ƒâ€
              exit 1
          }
          
          # 8. ä¸Šä¼ æ‰€æœ‰èµ„äº§
          Write-Host â€œæ­£åœ¨ä¸Šä¼ ZIPæ–‡ä»¶ [$ZIP_FILE]...â€
          $uploadResult1 = Invoke-RestMethod -Method Post -Uri â€œ$API/releases/$RELEASE_ID/assets?name=$ZIP_FILEâ€ `
              -Headers @{
                  Authorization = â€œtoken $TOKENâ€
                  â€˜Content-Typeâ€™ = â€˜application/octet-streamâ€™
              } -InFile $ZIP_FILE -ErrorAction SilentlyContinue
          
          Write-Host â€œæ­£åœ¨ä¸Šä¼ æ ¡éªŒæ–‡ä»¶ [$HASH_FILE]...â€
          $uploadResult2 = Invoke-RestMethod -Method Post -Uri â€œ$API/releases/$RELEASE_ID/assets?name=$HASH_FILEâ€ `
              -Headers @{
                  Authorization = â€œtoken $TOKENâ€
                  â€˜Content-Typeâ€™ = â€˜text/plainâ€™
              } -InFile $HASH_FILE -ErrorAction SilentlyContinue
          
          if (Test-Path $INSTALLER_PATH) {
              Write-Host â€œæ­£åœ¨ä¸Šä¼ Windowså®‰è£…å™¨ [FigSetup.exe]...â€
              $uploadResult3 = Invoke-RestMethod -Method Post -Uri â€œ$API/releases/$RELEASE_ID/assets?name=FigSetup.exeâ€ `
                  -Headers @{
                      Authorization = â€œtoken $TOKENâ€
                      â€˜Content-Typeâ€™ = â€˜application/octet-streamâ€™
                  } -InFile $INSTALLER_PATH -ErrorAction SilentlyContinue
          } else {
              Write-Host â€œâš ï¸  è­¦å‘Šï¼šæœªæ‰¾åˆ°å®‰è£…å™¨æ–‡ä»¶ï¼Œè·³è¿‡ä¸Šä¼ â€
          }
          
          Write-Host â€œâœ… Windowsç‰ˆæœ¬ [$VERSION] å‘å¸ƒå®Œæˆï¼â€